AWSTemplateFormatVersion: "2010-09-09"
Description:
  IoT Senosor Data Collection Pipeline
Parameters:
  TimeStreamTableARN:
    Description: Passed from CDK Stack to be used for Rule Action Role
    Type: String
Resources:
  IoTRuleTimeStreamAccessRole:
    Type: AWS::IAM::Role
    Properties:
      Description: Allows the IoT rule to access the TimeStream database
      RoleName: IoTAccessToTimeStreamCF
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - iot.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: 'AccessTimestreamDBPolicy'
          PolicyDocument:
            Version: "2012-10-17"
            Statement: 
              - Effect: Allow
                Action: timestream:WriteRecords
                Resource: 
                  Ref: TimeStreamTableARN
              - Effect: Allow
                Action: timestream:DescribeEndpoints
                Resource: '*'

  IoTTopicRuleToTimestream:
    Type: AWS::IoT::TopicRule
    Properties:
      RuleName: CFTestRule
      TopicRulePayload:
        Description: Sends IoT device data to a TimeStream database
        AwsIotSqlVersion: 2015-10-08
        RuleDisabled: "false"
        Sql: !Sub |
          SELECT Data.*
          FROM 'test/temp'
        Actions:
          - Timestream:
              DatabaseName: CFTestDB
              TableName: CFTestTable
              Dimensions:
                - Name: Device_ID
                  Value: ${Device_ID}
              RoleArn: !GetAtt IoTRuleTimeStreamAccessRole.Arn
